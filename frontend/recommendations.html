<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphRec - Results</title>
    <!-- Version bump to force refresh -->
    <link rel="stylesheet" href="css/styles.css?v=6">
</head>
<body>

<div class="container">
    <nav>
        <a href="index.html">Discover</a>
        <a href="recommendations.html" class="active">For You</a>
    </nav>

    <div class="dashboard-grid">
        <div class="card full-width" style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h2>Target User</h2>
                <div class="control-group">
                    <label>ID</label>
                    <input type="number" class="user-id-input" min="1">
                </div>
            </div>
            <button onclick="renderRecommendations()">Generate Recommendations</button>
        </div>
    </div>

    <div class="card">
        <h2>Top Picks</h2>
        <div id="results-area">
            <p style="color: var(--text-muted);">Click Generate to traverse the graph.</p>
        </div>
    </div>

    <div style="text-align:center; color: var(--text-muted); font-family:monospace; font-size:0.8rem; margin-top:40px;">
        <span id="metrics-area">Loading engine stats...</span>
    </div>
</div>

<script src="js/app.js"></script>
<script>
    async function renderRecommendations() {
        const container = document.getElementById('results-area');
        container.innerHTML = '<div style="padding:20px; text-align:center">Analyzing Graph...</div>';

        const data = await fetchRecommendations();

        if (!data) {
            container.innerHTML = '<p style="color:var(--text-muted)">Error contacting backend.</p>';
            return;
        }

        if (data.recommendations.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding: 40px;">
                    <p>No recommendations found.</p>
                    <small>Try liking some movies in the <strong>Discover</strong> tab!</small>
                </div>
            `;
        } else {
            const ul = document.createElement('ul');
            ul.className = 'rec-list';
            
            data.recommendations.forEach(item => {
                const li = document.createElement('li');
                li.className = 'rec-item';
                
                let reasonColor = item.reason.includes("Graph") ? "#6366f1" : "#eab308";

                li.innerHTML = `
                    <!-- 1. Mini Poster with Genre Gradient -->
                    <div class="mini-poster ${item.category}"></div>
                    
                    <div style="flex-grow:1">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <!-- 2. Title -->
                            <div style="font-size:1.2rem; font-weight:700;">${item.title}</div>
                            <!-- 3. Colored Badge -->
                            <span class="badge ${item.category}">${item.category}</span>
                        </div>
                        
                        <!-- 4. Reason Footer -->
                        <div style="margin-top:8px; font-size:0.8rem; color:var(--text-muted); display:flex; align-items:center; gap:6px;">
                            <span style="color:${reasonColor}; font-size:1.2em; line-height:0;">‚óè</span>
                            <span>${item.reason}</span>
                        </div>
                    </div>
                `;
                ul.appendChild(li);
            });
            
            container.innerHTML = '';
            container.appendChild(ul);
            
            const meta = document.createElement('div');
            meta.style.marginTop = '20px';
            meta.style.fontSize = '0.8rem';
            meta.style.color = 'var(--text-muted)';
            meta.style.display = 'flex';
            meta.style.justifyContent = 'space-between';
            meta.style.borderTop = '1px solid var(--glass-border)';
            meta.style.paddingTop = '15px';
            
            const sourceColor = (data.source && data.source.includes("Redis")) ? "#4ade80" : "var(--text-muted)";

            meta.innerHTML = `
                <span>Time: ${data.latency_ms.toFixed(4)} ms</span>
                <span style="color: ${sourceColor}; font-weight: 600;">From: ${data.source || 'Backend'}</span>
            `;
            container.appendChild(meta);
        }
        
        renderMetrics();
    }

    async function renderMetrics() {
        const metrics = await fetchMetrics();
        const area = document.getElementById('metrics-area');
        if (metrics) {
            area.innerHTML = `Nodes: ${metrics.nodes_users + metrics.nodes_items} | Edges: ${metrics.edges_interactions}`;
        }
    }

    window.addEventListener('userChanged', renderRecommendations);
    
    // --- FIX: Run immediately on page load ---
    renderRecommendations();
    renderMetrics();
</script>

</body>
</html>