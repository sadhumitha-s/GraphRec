<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphRec - Results</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

<div class="container">
    <nav>
        <a href="index.html">Interact</a>
        <a href="recommendations.html" class="active">Recommendations</a>
    </nav>

    <div class="card">
        <h2>Target User</h2>
        <div class="control-group">
            <label>Get recommendations for User ID:</label>
            <input type="number" class="user-id-input" min="1">
            <button onclick="renderRecommendations()">Refresh</button>
        </div>
    </div>

    <div class="card">
        <h2>Live Recommendations</h2>
        <div id="results-area">
            <p style="color: var(--text-muted);">Click Refresh to traverse the graph.</p>
        </div>
    </div>

    <div class="card">
        <h2>Engine Metrics</h2>
        <div id="metrics-area" style="font-family: monospace; color: var(--text-muted);">
            <span>Loading metrics...</span>
        </div>
    </div>
</div>

<script src="js/app.js"></script>
<script>
    async function renderRecommendations() {
        const container = document.getElementById('results-area');
        container.innerHTML = '<p>Traversing graph...</p>';

        const data = await fetchRecommendations();

        if (!data) {
            container.innerHTML = '<p style="color:var(--text-muted)">Error contacting backend.</p>';
            return;
        }

        if (data.recommendations.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding: 40px;">
                    <p>No recommendations found.</p>
                    <small>Go to the <strong>Interact</strong> page and like some items first!</small>
                </div>
            `;
        } else {
            const ul = document.createElement('ul');
            ul.className = 'rec-list';
            
            data.recommendations.forEach(item => {
                const li = document.createElement('li');
                li.className = 'rec-item';
                
                // Classy Text Color for strategy
                // Blue for Graph, Gold for Trending/Catalog
                let reasonColor = item.reason.includes("Graph") 
                    ? "#3b82f6"  // Blue
                    : "#eab308"; // Gold/Yellow

                // New Layout: Title row first, then Reason row underneath
                li.innerHTML = `
                    <div style="width: 100%">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                            <strong>${item.title}</strong>
                            <span class="badge ${item.category}">${item.category}</span>
                        </div>
                        
                        <div style="font-size: 0.8rem; color: var(--text-muted); display:flex; align-items:center; gap:6px;">
                            <span style="color:${reasonColor}; font-size:1.2em; line-height:0;">‚óè</span>
                            <span>${item.reason}</span>
                        </div>
                    </div>
                `;
                ul.appendChild(li);
            });
            
            container.innerHTML = '';
            container.appendChild(ul);
            
            const meta = document.createElement('div');
            meta.style.marginTop = '20px';
            meta.style.fontSize = '0.85rem';
            meta.style.color = 'var(--text-muted)';
            meta.style.display = 'flex';
            meta.style.justifyContent = 'space-between';
            
            // Show Latency AND Source
            meta.innerHTML = `
                <span>Computed in ${data.latency_ms.toFixed(4)} ms</span>
                <span style="color: ${data.source.includes('Redis') ? '#10b981' : '#a1a1aa'}">
                    From: ${data.source}
                </span>
            `;
            container.appendChild(meta);
        }
        
        renderMetrics();
    }

    async function renderMetrics() {
        const metrics = await fetchMetrics();
        const area = document.getElementById('metrics-area');
        if (metrics) {
            area.innerHTML = `
                <span>Nodes: ${metrics.nodes_users + metrics.nodes_items}</span>
                <span style="margin-left:15px">Edges: ${metrics.edges_interactions}</span>
            `;
        }
    }

    window.addEventListener('userChanged', renderRecommendations);
    renderMetrics();
</script>

</body>
</html>