version: '3.8'

services:
  # 1. Local Redis (Runs automatically, used only if .env points to it)
  redis:
    image: redis:alpine
    ports:
      - "6379:6379"

  # 2. Main App (Backend + Frontend)
  app:
    build: .
    container_name: graphrec_container
    ports:
      - "8000:8000"
    
    # Load secrets from .env (Supabase/Upstash)
    env_file:
      - backend/.env
    
    environment:
      - PYTHONUNBUFFERED=1
      # HYBRID MAGIC:
      # 1. Tries to use REDIS_URL from .env (Upstash)
      # 2. If missing, defaults to 'redis://redis:6379/0' (The local container above)
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      
    depends_on:
      - redis
      
    volumes:
      # Map local folders for Hot Reloading (Edits on Mac = Edits in Docker)
      - ./backend:/app/backend
      - ./frontend:/app/frontend
      # Exclude the compiled .so file so Mac binaries don't break Linux
      - /app/backend/recommender*.so